{% extends 'base.html' %}
{% block header %}
{% load leaflet_tags %}
{% load static %}
{% load crispy_forms_tags %}
{% leaflet_js %}
{% leaflet_css %}

<script type="text/javascript">
  $(document).ready(function(){
  $("#check_user").click(function(){
        $("#display_review").toggle();
    });
  });
  let latitude = {{ object.latitude }};
  let longitude = {{ object.longitude }};
  window.addEventListener("map:init", (event) => {
    let zoomLevel = 13;
    let map = event.detail.map.setView([latitude, longitude], zoomLevel);
    L.marker([latitude, longitude])
    .addTo(map)
    .bindPopup(`<a target="_blank" href="{{object.google_map_url}}">Open Google Maps</a>`)
    .openPopup();

  });


</script>
{% endblock%}

{% block content %}
<h1>{{object.address}}, {{object.city}}, {{object.state}}, {{object.zipcode}}</h1>
{% leaflet_map "leaflet_map_main" %}

<hr>

<h2>Zillow</h2>
{% if object.zillow_set.all %}
<ul>
{% for zillow in object.zillow_set.all %}
<li>
  <a href={{zillow.url}}>
  <h3>
    {% if zillow.suite_num %}
      <span class="badge badge-secondary">#{{zillow.suite_num}}</span>
    {% endif %}
    {{zillow.estimated_rent_price_for_display}}
  </h3>
  </a>
</li>
{% endfor %}
</ul>
{% else %}
<p>No data from Zillow</p>
{% endif %}
<i>Last update: {{object.last_fetched_zillow}}</i>

{% if request.user.is_authenticated and user.user_type_string == "Renter" %}
    <form action="{% url 'favorite' object.id %}" method="POST">
    {% csrf_token %}
    {% if object in request.user.favorites.all %}
        <button type="submit"><img src="https://img.icons8.com/color/64/000000/hearts.png"></button>
    {% else %}
        <button type="submit"><img src="https://img.icons8.com/material-outlined/64/000000/hearts.png"></button>
    {% endif %}
    </form>
<!--
Uncomment to display messages indicating confirmation of favorited/unfavorited apartment.
{% if messages %}
<ul>
  {% for message in messages %}
    {% if 'apartment' in message %}
        <li style="color:green">
            {{ message }}
        </li>
    {% endif %}
  {% endfor %}
</ul>
{% endif %}
-->
{% endif %}
    {% if object.review_set %}
        <h2> Review: </h2>
        <hr class="mt-0 mb-2 mt-2">
        <div class="row h-65">
            <div class="col">
                <table class="table table-striped table-bordered table-hover table-sm results-table" width="100%">
                    <thead>
                        <tr>
                            <th scope="col" class="th-sm">Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for review in object.review_set.all %}
                        <tr>
                            <td scope="row">
                                {{ review.user }} @ {{ review.time }}  :
                                <br><br>
                                {{ review.content }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <h2>Write some review:</h2>
    {% if request.user.user_type_string == "Tenant" %}
        <input class="btn btn-outline-primary" id="check_user" name="check_user" value="Write something">
            <div id="display_review" class="hidden">
                <form action="{% url "review" object.id %}" method="post">
                    {% csrf_token %}
                    {{ form }}
                    <input type="submit" value="Submit" name="form_submit">
                </form>
            </div>
    {% else %}
        <p>Cannot write review for this location. Because you are not tenant.</p>
    {% endif %}

{% endblock %}
